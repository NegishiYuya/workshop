# S3 を使った静的ホスティング

## 目的

-   AWS の以下の機能についての理解度を高める
    -   S3
    -   CloudFront
    -   Route53
-   AWS を使って汎用的な Web サイトを公開できるようにする
    -   目に見えるものを成果物を作りながら、AWS の機能を総合的に復習する

## 成果物イメージ

-   ドメインが指定された状態の Web サイトが公開されている

## 手順の概要

### S3 の設定

1.  S3 バケットを作成する
2.  ファイルをアップロードする
3.  S3 に対して静的ホスティングの設定を施す
4.  バケットへのアクセス制限を変更し、ページを公開する

### CloudFront の設定

5. CloundFront ディストリビューションを作成し、S3 と紐づける
6. S3 への直接アクセスによる web ページ閲覧をできないようにする

### Route53 + SSL 証明書 の設定

7. ドメインを取得する
8. Route53 でホストゾーンを作成する
9. AWS CertificateManager + Route53 で SSL 証明書を作成する
10. CloudFront へ SSL 証明書を設定する
11. Route53 に CloudFront のドメインを紐づける

### 参考記事

-   [【AWS】S3+CloudFront+Route53+ACM で SSL 化(https)した静的 Web サイトを公開する](https://zenn.dev/wakkunn/articles/66a6e8372611dc)
-   [初心に戻って AWS で静的 Web サイトを作成する - Qiita](https://qiita.com/leomaro7/items/345c3978b74edb5e346c)
-   [バケットポリシーってなんだろ？](https://zenn.dev/mn87/articles/726f7e3574e2fb)

## 手順(CloudFront で公開まで)

### S3 バケットを作成する

1. AWS コンソールにログインする
2. サービスメニューから`S3`を選択
3. 左のメニューから`バケット`を選択
4. 画面右側にある`バケットを作成`を押下
5. 作成画面にて以下を入力する
    - バケット名 : `workshopXX0314`
        - XX には個々人の番号を。
    - `このバケットのブロックパブリックアクセス設定` : チェックを外す
        - `現在の設定により、このバケットとバケット内のオブジェクトが公開される可能性があることを承認します。`にチェックを入れる

### ファイルをアップロードする

1. 作成したバケットにフォルダ`006`に格納しているファイル一式をアップロードする

### S3 に対して静的ホスティングの設定を施す

1. バケットの画面の`プロパティ`タブを押下する
2. 項目`静的ウェブサイトホスティング`の`編集`を押下する
3. 以下を入力し、`変更の保存`を押下する

    - `静的ウェブサイトホスティング` : `有効にする`
    - `インデックスドキュメント` : `index.html`

4. この時点で`バケットウェブサイトエンドポイント`
   ができているが、サイトが公開できていないことを確認する

### バケットへのアクセス制限を変更し、ページを公開する

1. バケットの画面の`アクセス許可`タブを押下する
2. `バケットポリシー`の`編集`を押下する
3. `ポリシージェネレータ`を押下する
4. 画面内で以下を選択する
    - `Select Type of Policy` : `S3 Bucket Policy`
    - `Principal` : `*`
    - `Actions` : `GetObject`
    - `Amazon Resource Name (ARN)` : `arn:aws:s3:::バケット名/*`
5. `Add Statement`を押下する
6. `Generate Policy`を押下する
7. モーダルで表示される json をコピーする
8. 元の画面の`ポリシー`に貼り付ける
9. 画面右下の`変更の保存`を押下する
10. 画面内のバケット名の下に`パブリックにアクセス可能 `と表示されていることを確認する
11. 再度　バケットの画面の`プロパティ`タブを開く
12. 画面下部の`バケットウェブサイトエンドポイント `に記載の URL を開く
13. Web サイトを開けることを確認する

### CloundFront ディストリビューションを作成し、S3 と紐づける・S3 への直接アクセスによる web ページ閲覧をできないようにする

1. サービスメニューから`CloudFront`を選択
2. `CloudFront ディストリビューションを作成`を押下する
3. 以下のように入力し、保存する
    - `オリジンドメイン` : 作成した S3 のバケット名が含まれている S3 のアドレス
    - `S3 バケットアクセス`
        - `はい、OAI を使用します (バケットは CloudFront のみへのアクセスとなるように制限できます)`
        - `新しいOAIを作成`
        - `はい、バケットポリシーを自動で更新します`
    - `ビューワープロトコルポリシー` : `Redirect HTTP to HTTPS`
    - `デフォルトルートオブジェクト - オプション` : `index.html`
4. ディストリビューションの画面の`一般`タブを押下する
5. `最終変更日`に日付が入ればディストリビューションがデプロイ完了となる
6. `ディストリビューションドメイン名`に記載のドメインにアクセスし、Web サイトを開けることを確認する
7. S3 の`バケットウェブサイトエンドポイント `に記載の URL を開く、Web サイトが開けなくなっていることを確認する
8. 再度 S3 のメニューを開く
9. バケットの画面の`アクセス許可`タブを押下する
10. `バケットポリシー`の`編集`を押下する
11. バケットポリシーの`Statement`の配列の 1 件目の json を削除して、変更を保存する
12. 再度`ディストリビューションドメイン名`のドメインにアクセスし、Web サイトを開けることを確認する

---

## 手順(独自ドメインで公開)

### ドメイン・SSL 設定前の動作確認

1. ブラウザで`ディストリビューションドメイン名`のドメインを URL に設定してページを開く
2. ブラウザで証明書を開き、発行元に`*.cloudfront.net`が設定されていること
    - 証明書の確認方法：https://jp.globalsign.com/ssl/about/authentification.html
    - 証明書自体は設定されているが、独自ドメインを設定すると`証明書の発行元≠ドメイン`というねじれが発生する
        - そのため、後続の独自ドメインの設定と SSL 証明書はセットで行い、整合をとるようにする

### ドメインを取得する・Route53 でホストゾーンを作成する

1. 「お名前.com」などでドメインを取得する
2. サービスメニューから`Route53`を選択
3. `ホストゾーンの作成`を押下
4. 以下のように入力し、`ホストゾーンの作成`を押下する
    - `ドメイン名`:取得したドメイン名
5. `ホストゾーン`作成後に NS レコードができるため、そのルーティング名(4 件)を控える
6. 「お名前.com」の管理画面でドメインに紐づくネームサーバを Route53 で作成されたものに変更する

### AWS CertificateManager + Route53 で SSL 証明書を作成する

1. サービスメニューから`Certificate Manager`を選択
2. ヘッダーのメニューからリージョンを`米国東部(バージニア北部) us-east-1`に変更する
3. `証明書をリクエスト`を押下する
4. `証明書タイプ`は`パブリック証明書をリクエスト`のまま、`次へ`を押下
5. `完全修飾ドメイン名`にドメイン名を入れて、`リクエスト`を押下
6. 証明書の一覧に遷移したあと、`更新`ボタンを押して作成した証明書が一覧に表示されることを確認する
7. 作成した証明書の`証明書ID`を押下する
8. `Route53でレコードを作成`を押下する
9. `レコードを作成`を押下する
10. Route53 の画面にて`CNAME`のレコードができていることを確認する
11. 証明書が`発行済み`になることを確認する

### CloudFront へ SSL 証明書を設定する

1. サービスメニューから`CloudFront`を選択
2. 作成したディストリビューションの`ID`を押下
3. `一般`タブの中の`編集`を押下する
4. 以下を設定し、`変更を保存`を押下する
    - `代替ドメイン名 (CNAME) `: 取得したドメイン名
    - `カスタム SSL 証明書`: ドメインに紐づく証明書
5. 一覧の`最終変更日`に日時が表示されれば設定完了
    - 並行で Route53 の設定をしても問題ない

### Route53 に CloudFront のドメインを紐づける

1. サービスメニューから`Route53`を選択
2. 一覧より作成したホストゾーンを選択
3. `レコードを作成`を押下する
4. 以下を入力し、`レコードを作成`を押下する
    - レコードタイプ : `A`
    - 値 : `エイリアス`を ON にする・`CloudFrontディストリビューションへのエイリアス`を選択・作成したディストリビューションを選択

### 動作確認

1. ブラウザで作成したドメインを URL に設定してページを開く
    - 今までの工程で表示していたページが表示されること
2. ブラウザで証明書を開き、発行元に`作成したドメイン`が設定されていること
