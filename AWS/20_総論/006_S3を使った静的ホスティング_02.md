# S3 を使った静的ホスティング 第 2 回

## 第 1 回の内容で改めて、押さえておきたい知識

-   S3 を使うメリット
    -   高い可用性
        -   1 つのリージョン内 3AZ へのデータの複製
    -   コストメリット(安い単価・従量課金)
    -   AWS の他の機能との親和性が高い
    -   参考: [Amazon S3 とは？使用メリットや具体的な使い方を現役エンジニアが解説【初心者向け】 | TechAcademy マガジン](https://techacademy.jp/magazine/22676)
-   CloudFront を使うメリット
    -   「オリジン」と「エッジ」の仕組みによる配信速度向上と負荷分散
    -   AWS WAF や AWS Shield との連携による防御
    -   独自ドメイン＋ SSL 証明書の構成が取りやすい
    -   参考
        -   [AWS の Amazon CloudFront の特徴 5 選｜おすすめする理由とは？ | FEnet AWS コラム](https://www.fenet.jp/aws/column/aws-beginner/325/)
        -   [AWS における静的コンテンツ配信パターンカタログ（アンチパターン含む） | DevelopersIO](https://dev.classmethod.jp/articles/static-contents-delivery-patterns/)
-   バケットポリシー
    -   バケットへのアクセス制御の役割を持つ
    -   json で表現する
        -   Effect : `許可`・`拒否`
        -   Principal : `～が`
        -   Action : `～することを`
        -   Resource : `～に対して`
    -   S3 へのアクセスコントロールは、バケットポリシー以外では`IAM`での制御・S3 の機能である`ACL`がある
    -   参考
        -   [S3 のアクセス制御方法はバケットポリシーと ACL の２つがある](https://aws.darcy-it.com/s3-security/)
        -   [S3 のアクセスコントロールまとめ - Qiita](https://qiita.com/ryo0301/items/791c0a666feeea0a704c#acl-1)
        -   [AWS/S3 のバケットポリシー入門 | 酒と涙と Ruby と Rails と](https://morizyun.github.io/infrastructure/aws-s3-bucket-policy.html)
        -   [S3 のバケットポリシー書き方まとめ - Qiita](https://qiita.com/irico/items/a3ab1f8ebf1ece9cc783)
-   OAI
    -   `Origin Access Identity`(オリジンアクセスアイデンティティ)の略
    -   ユーザーが S3 バケットへ直接アクセスさせないようにする。CloudFront 経由ファイルにアクセスできるようにする仕組み。
        -   S3 へのアクセス集中を防ぐ
    -   参考
        -   [AWS CloudFront でオリジンを守ろう！(S3 編) | サイバーマトリックス株式会社](https://www.cybermatrix.co/blog/waf/aws-cloudfront-passlimit-s3/)
        -   [CloudFront + S3 構築のポイント | Oji-Cloud](https://oji-cloud.net/2021/01/02/post-5754/)

---

## 手順の概要

### Route53 + SSL 証明書 の設定

7. ドメインを取得する
8. Route53 でホストゾーンを作成する
9. AWS CertificateManager + Route53 で SSL 証明書を作成する
10. CloudFront へ SSL 証明書を設定する
11. Route53 に CloudFront のドメインを紐づける

---

## 手順

### ドメイン・SSL 設定前の動作確認

手順の意味合い：証明書が cloudfront のデフォルトのものであることを確認する

1. ブラウザで`ディストリビューションドメイン名`のドメインを URL に設定してページを開く
2. ブラウザで証明書を開き、発行元に`*.cloudfront.net`が設定されていること
    - 証明書の確認方法：https://jp.globalsign.com/ssl/about/authentification.html
    - 証明書自体は設定されているが、独自ドメインを設定すると`証明書の発行元≠ドメイン`というねじれが発生する
        - そのため、後続の独自ドメインの設定と SSL 証明書はセットで行い、整合をとるようにする

### ドメインを取得する・Route53 でホストゾーンを作成する

手順の意味合い：静的ホスティングされるサイトに対して、独自のドメインをつける準備をする

1. 「お名前.com」などでドメインを取得する
2. サービスメニューから`Route53`を選択
3. `ホストゾーンの作成`を押下
4. 以下のように入力し、`ホストゾーンの作成`を押下する
    - `ドメイン名`:取得したドメイン名
5. `ホストゾーン`作成後に NS レコードができるため、そのルーティング名(4 件)を控える
6. 「お名前.com」の管理画面でドメインに紐づくネームサーバを Route53 で作成されたものに変更する

### AWS CertificateManager + Route53 で SSL 証明書を作成する

手順の意味合い：作成したドメインに紐づく SSL 証明書を発行する

1. サービスメニューから`Certificate Manager`を選択
2. ヘッダーのメニューからリージョンを`米国東部(バージニア北部) us-east-1`に変更する
3. `証明書をリクエスト`を押下する
4. `証明書タイプ`は`パブリック証明書をリクエスト`のまま、`次へ`を押下
5. 以下を入力して`リクエスト`を押下
    - `完全修飾ドメイン名`: ドメイン名
    - `検証方法を選択`: DNS 検証
6. 証明書の一覧に遷移したあと、`更新`ボタンを押して作成した証明書が一覧に表示されることを確認する
7. 作成した証明書の`証明書ID`を押下する
8. `Route53でレコードを作成`を押下する
9. `レコードを作成`を押下する
10. Route53 の画面にて`CNAME`のレコードができていることを確認する
11. 証明書が`発行済み`になることを確認する

-   8 以降の手順でなぜ証明書を作成した後に、Route53 のレコードを作っているかの参考
    -   [AWS Certificate Manager を使って無料で SSL 証明書を発行する - Qiita](https://qiita.com/masatomix/items/7c90f1a625c736af5a81)
    -   [ACM で証明書を作る時は DNS 検証にした方が良い - Blog メモ φ(..)](https://blog.nightonly.com/2020/08/16/acm%E3%81%A7%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%82%92%E4%BD%9C%E3%82%8B%E6%99%82%E3%81%AFdns%E6%A4%9C%E8%A8%BC%E3%81%AB%E3%81%97%E3%81%9F%E6%96%B9%E3%81%8C%E8%89%AF%E3%81%84/)

### CloudFront へ SSL 証明書を設定する

手順の意味合い：CloudFront に対して 独自ドメインに対応した SSL 証明書を紐づける(デフォルトから変更する)

1. サービスメニューから`CloudFront`を選択
2. 作成したディストリビューションの`ID`を押下
3. `一般`タブの中の`編集`を押下する
4. 以下を設定し、`変更を保存`を押下する
    - `代替ドメイン名 (CNAME) `: 取得したドメイン名
    - `カスタム SSL 証明書`: ドメインに紐づく証明書
5. 一覧の`最終変更日`に日時が表示されれば設定完了
    - 並行で Route53 の設定をしても問題ない

### Route53 に CloudFront のドメインを紐づける

手順の意味合い：独自ドメインでアクセスしたときに CloudFront に疎通できるようにする

1. サービスメニューから`Route53`を選択
2. 一覧より作成したホストゾーンを選択
3. `レコードを作成`を押下する
4. 以下を入力し、`レコードを作成`を押下する
    - レコードタイプ : `A`
    - 値 : `エイリアス`を ON にする・`CloudFrontディストリビューションへのエイリアス`を選択・作成したディストリビューションを選択

### 動作確認

手順の意味合い：疎通確認＋証明書の妥当性確認

1. ブラウザで作成したドメインを URL に設定してページを開く
    - 今までの工程で表示していたページが表示されること
2. ブラウザで証明書を開き、発行元に`作成したドメイン`が設定されていること
