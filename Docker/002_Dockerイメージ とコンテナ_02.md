## Docker イメージ とコンテナ(2)

### 再掲：Docker イメージ とコンテナ

Docker のイメージとコンテナの関係性について振り返る。
Docker のイメージは「ひな形」であり、コンテナは環境そのものである。
つまり、イメージから同様のコンテナをすぐに作ることができる。また、複製することができる。

### Dockerイメージの作成

Dockerイメージの作成は2種類ある。  
-   (1) Dockerコンテナに対して直接修正を施して、`docker commit`コマンドを実行する(参考：https://knowledge.sakura.ad.jp/14427/)
    -   まずベースOSのイメージからコンテナを作成する
    -   作成したコンテナに対してbashなどでログインする
    -   コンテナ内に必要なファイル(インストールしたいソフトウェアの資材や設定ファイルなど)を`docker cp`コマンドなどでローカルからコピーする
    -   必要なソフトウェアをインストールする
    -   ソフトウェアの設定をコマンドにて行う
    -   コンテナからログアウトする
    -   `docker commit`コマンドを実行して、コンテナに対して施した修正を確定させイメージ化する
    -   配布の方法
       -   DockerHubやECRに作成したイメージをPUSHして、それを使う人側でPULLする
-   (2) Dockerfileをビルドする(参考：https://knowledge.sakura.ad.jp/15253/)
    -   Dockerfileに対してイメージを作成するために必要な命令・手順を記載する
    -   `docker build`コマンドを実行して、イメージ化する
    -   配布の方法
       -   DockerfileをGitにPUSHして、それを使う人側でPULLする
       -   イメージをDockerHubやECRに作成したイメージをPUSHして、それを使う人側でPULLする

#### それぞれのメリット・デメリット

(1)Dockerコンテナに対して直接修正を施す方法
-   メリット
    -   一時的な修正や実験に有効
-   デメリット
    -   イメージ作成の手順がわからなくなる(修正や設定値の経緯や意図がわからない)
        -   運用・保守がしづらい、属人化の発生
(2)Dockerfileをビルドする
-   メリット
    -   イメージ作成の手順がファイルで残る(修正や設定値の経緯や意図を残すことができる)
        - Gitなどとの合わせ技で履歴の管理やCICDとの連携ができる。各種自動化ができるようになる。
        - インフラをコードで管理できる(IaC:Infrastructure as Codeの実現)   
    -   配布がしやすい
-   デメリット
    -   Dockerfile作成の学習コスト
        -   コマンドを書くという行為は(1)と共通している部分だが、コンテナ内でコマンドを打つのと少し勝手が違うところもある。

Dockerfileをビルドする方法でイメージを作ったほうが、Dockerを使うメリットをより享受できる。

### Dockerfileの記法と作り方

Dockerfileはイメージ作成の手順書のようなもの。  
ベースになるイメージを選定し、そこから作成したコンテナに対しての修正手順をファイルに起こすというもの。 

https://knowledge.sakura.ad.jp/15253/ の記事にコメントを追加した、以下のファイルを参照されたい。  
https://github.com/NegishiYuya/workshop/blob/master/Docker/dockerfileSample/Dockerfile  

-   FROM…ベースとなるイメージをどれにするかの宣言。タグを指定することで特定のバージョンのイメージを指定することができる。
-   RUN…イメージ作成時にコンテナ内部で実行するコマンド。
    -   1行1行の命令が独立しているため、注意が必要。
        -   https://knowledge.sakura.ad.jp/15253/ の「Dockerfileの各コマンドは、毎回コンテナを起動して実行している」の内容
-   COPY,ADD…ホスト端末からコンテナにファイルをコピーする。ADDは圧縮ファイルの解凍まで行う。
    -   リモートから取得したファイルなどの解凍はセキュリティリスクもあるため注意されたい。
-   CMD…コンテナ起動時に実行するコマンド。
    -   多くのコマンドを実行できないため、多くのコマンドを実行したい場合はshellファイルなどに実行したいコマンドをまとめておき、そのshellファイルを実行させるようにする

また、Dockerfileの1行1行のコマンドによって、イメージの`レイヤー`が形成される。  
作成済のイメージに同じようなレイヤーがある場合は、再度のコマンドの実行をせずにキャッシュの仕組みを使う。   
そのため、似たようなのイメージを複数作る場合は序盤のレイヤーに共通的な基盤を作る処理を記載すれば、  
キャッシュを使うことができるので、 イメージのサイズ節約が見込める。  

そのほかのコマンドや書き方のベストプラクティスについては、様々な技術書やネット記事もあるので、  
そちらも併せて参照されたい。

参考：
-   https://www.wakuwakubank.com/posts/270-docker-build-image/
-   https://qiita.com/pottava/items/452bf80e334bc1fee69a
-   https://www.slideshare.net/zembutsu/explaining-best-practices-for-writing-dockerfiles
